---
layout: post
title: Pentesting OSX Software
---

Enumeration
Generally I would start with a pkg file to see whats being written to disk, but in this case all I had was a previously installed
version to test.

The first thing I noticed was there were several services associated with this application that are running as root
```
➜  ~ ps aux | grep -i zscaler
root             13377  21.9  0.1  6692360  38376   ??  Ss    9:18PM   0:31.18 /Library/Application Support/Zscaler/UPM/UPMServiceController
root             13387   0.0  0.0  6695692  17176   ??  Ss    9:18PM   0:01.74 /Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerTunnel
root             13355   0.0  0.0  5753088  18828   ??  Ss    9:18PM   0:00.40 /Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerService
jtulowiecki      13354   0.0  0.1  6959252  68460   ??  S     9:18PM   0:01.94 /Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler
```

To find out how these are being loaded, I looked to the startup files. The following two folders will run the service as root
```
➜  ~ find /Library/LaunchDaemons /System/Library/LaunchDaemons -type f | grep -i zscaler
/Library/LaunchDaemons/com.zscaler.service.plist
/Library/LaunchDaemons/com.zscaler.tunnel.plist
/Library/LaunchDaemons/com.zscaler.UPMServiceController.plist
```

And then these two directories will launch as user
```
➜  ~ find /Library/LaunchAgents /System/Library/LaunchAgents -type f | grep -i zscaler
/Library/LaunchAgents/com.zscaler.tray.plist
```

Now I went through each and looked to see if I could find anything interesting in these files:

```
cat /Library/LaunchDaemons/com.zscaler.service.plist
....
<dict>
	<key>Label</key>
	<string>com.zscaler.service</string>
	<key>MachServices</key>
	<dict>
		<key>com.zscaler.service-tray-communication</key>
		<true/>
	</dict>
	<key>EnvironmentVariables</key>
	<dict>
		<key>OPT</key>
		<string>ZSCALER</string>
	</dict>
	<key>ProgramArguments</key>
	<array>
		<string>/Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerService</string>
	</array>
	<key>KeepAlive</key>
	<dict>
		<key>SuccessfulExit</key>
		<false/>
	</dict>
	<key>RunAtLoad</key>
	<true/>
	<key>StandardErrorPath</key>
	<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerService.log</string>
	<key>StandardOutPath</key>
	<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerServiceOut.log</string>
</dict>
</plist>
```
KeepAlive is set, so the service should always be running. RunAtLoad is set, so this launches at startup, its
in the Daemons folder so it launches as root. An environment variable is set OPT=ZSCALER
Thats interesting, because it could be input into the application. The application is not passed any args

There are no ports being opened up or anythinglike that but there are two files referenced to show where
stdout and stderr write to:
```
<key>StandardErrorPath</key>
<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerService.log</string>
<key>StandardOutPath</key>
<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerServiceOut.log</string>
```

This could prove useful later on as well. Also of interest is this:
```
<key>MachServices</key>
<dict>
	<key>com.zscaler.service-tray-communication</key>
	<true/>
</dict>
```

This tells launchd to create a Mach port and register it with the bootstrap service with the given string. Other services 
can then lookup the service by name, and send messages to it. So this is another potential attack vector depending on what
the application is doing with the message.

The results are fairly similar for this one:
```
cat /Library/LaunchDaemons/com.zscaler.tunnel.plist
```

The same environment variable is set, runatload, keepalive. The log files are different:
<key>StandardErrorPath</key>
	<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerTunnel.log</string>
	<key>StandardOutPath</key>
	<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerTunnelOut.log</string>

A different Mach port is registered for this one:
<key>MachServices</key>
	<dict>
		<key>com.zscaler.tray-tunnel-communication</key>
		<true/>
	</dict>

The other file is again similar with the only differences being the mach port and the log files
➜  ~ cat /Library/LaunchDaemons/com.zscaler.UPMServiceController.plist
<key>MachServices</key>
	<dict>
		<key>com.zscaler.UPMServiceController</key>
		<true/>
	</dict>
<key>StandardErrorPath</key>
    <string>/Library/Application Support/Zscaler/Logs/com.zscaler.UPMServiceController_stderr.log</string>
    <key>StandardOutPath</key>
    <string>/Library/Application Support/Zscaler/Logs/com.zscaler.UPMServiceController_stdout.log</string>

The other one in LaunchAgents doesn't appear to be particularly interesting because it doesnt run as root,
has no log files or mach ports. I'll make a note that its there but there isn't much to go on there for now.

The first thing I will do is kill all of these processes and try to launch them from scratch while using processmonitor for osx to try to get an idea what they are doing when they start up and how they are interacting together.

These are the three executables that run as root and launch at startup:
```
/Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerService
/Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerTunnel
/Library/Application Support/Zscaler/UPM/UPMServiceController
```

After killing all 3, and attempting to restart while monitoring with processmonitor, the only one that stays running is /Library/Application Support/Zscaler/UPM/UPMServiceController. The other two return immediately. Trying to understand why this is, I opened up one of them in ghidra.
Looking at ZscalerTunnel, it looks like there may be a check to see if its running as a daemon or not and then exiting out if its not. 

![image](/assets/images/daemon.png)

Testing this hypothesis would be more time efficient than diving into the reverse engineering so lets go ahead and do that.

```
$ sudo launchctl load /Library/LaunchDaemons/com.zscaler.tunnel.plist
$ sudo launchctl start com.zscaler.tunnel
$ sudo launchctl list | grep com.zscaler.tunnel
```

Checking to see if its running
```
➜  ~ ps aux | grep ZscalerTunnel
root             88747   0.0  0.0  4870080   7616   ??  Ss    3:12PM   0:00.04 /Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerTunnel
```
Now its running, so it looks like our theory was correct. Now that we are able to successfully start this application without it immediately shutting down, lets try to monitor what its doing. Again, I will start with the simplest approach, which is just to run processmonitor.

```
$ sudo launchctl stop com.zscaler.tunnel
$ sudo launchctl unload /Library/LaunchDaemons/com.zscaler.tunnel.plist
$ sudo launchctl list | grep com.zscaler.tunnel
```
And its no longer running.

Trying to run processmonitor and then launch zscaler tunnel in a separate window, did not show any results, starting zscalerservice, also did not cause zscalertunnel to do anything
First window:
```
➜  sudo ~/Desktop/ProcessMonitor.app/Contents/MacOS/ProcessMonitor -pretty -filter ZScalerTunnel
```
Second window:
```
➜ sudo launchctl load /Library/LaunchDaemons/com.zscaler.tunnel.plist
➜ sudo launchctl start com.zscaler.tunnel
➜ sudo launchctl list | grep com.zscaler.tunnel
91571	0	com.zscaler.tunnel
```

Now lets try monitoring Zscaler Service


First window:
```
➜  sudo ~/Desktop/ProcessMonitor.app/Contents/MacOS/ProcessMonitor -pretty -filter ZScalerService
```
Second window:
```
➜ sudo launchctl load /Library/LaunchDaemons/com.zscaler.service.plist
➜ sudo launchctl start com.zscaler.service
➜ sudo launchctl list | grep com.zscaler.service

```

Neither of these executables exhibited any behavior, not even an exec when launched as a daemon. This is interesting, even if the process wasn't doing anything, an exec be happening somewhere. For it not to show makes me think that launchctl services may not be picked up by process monitor. I'm not sure but at this point we still need some more information because we need to understand how they services interact with eachother if we are to do any meaningful assessment.

This is whats running at startup. Each one has a corresponding plist file.

```
➜  ~ ps -A | grep Zscaler
   91 ??         0:00.34 /Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerTunnel
  123 ??         0:00.28 /Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerService
 1064 ??         0:00.78 /Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler
 1229 ??         0:00.76 /Library/Application Support/Zscaler/UPM/UPMServiceController
 ```

 My next step is to write a script that tears down all of these services and then launches them all again with launchd in the same order that they were started above. This will make it easy to replicate the startup process so any process monitoring is taking place in an environment that is a replication of what exactly happens at startup.

 shutdown.sh
 ```
#!/bin/bash

sudo launchctl stop com.zscaler.service
sudo launchctl unload /Library/LaunchDaemons/com.zscaler.service.plist

sudo launchctl stop com.zscaler.tunnel
sudo launchctl unload /Library/LaunchDaemons/com.zscaler.tunnel.plist

launchctl stop com.zscaler.tray
launchctl unload /Library/LaunchAgents/com.zscaler.tray.plist

sudo launchctl stop com.zscaler.UPMServiceController
sudo launchctl unload /Library/LaunchDaemons/com.zscaler.UPMServiceController.plist
```

startup.sh
```
#!/bin/bash

sudo launchctl load /Library/LaunchDaemons/com.zscaler.UPMServiceController.plist
sudo launchctl start com.zscaler.UPMServiceController

launchctl load /Library/LaunchAgents/com.zscaler.tray.plist
launchctl start com.zscaler.tray

sudo launchctl load /Library/LaunchDaemons/com.zscaler.tunnel.plist
sudo launchctl start com.zscaler.tunnel

sudo launchctl load /Library/LaunchDaemons/com.zscaler.service.plist
sudo launchctl start com.zscaler.service
```

Ok we are finally getting output for two of the services. Lets examine them:

*UPMServiceController*
```
➜  ~ sudo ~/Desktop/ProcessMonitor.app/Contents/MacOS/ProcessMonitor -pretty -filter UPMServiceController
Password:
{
  "event" : "ES_EVENT_TYPE_NOTIFY_EXEC",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.UPMServiceController",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 0,
    "arguments" : [
      "/Library/Application Support/Zscaler/UPM/UPMServiceController"
    ],
    "ppid" : 1,
    "ancestors" : [
      1
    ],
    "rpid" : 14114,
    "architecture" : "unknown",
    "path" : "/Library/Application Support/Zscaler/UPM/UPMServiceController",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.UPMServiceController",
      "platformBinary" : 0,
      "cdHash" : "01B61E0427A76C25E77DBBDA823DB9BDEBF36623"
    },
    "name" : "UPMServiceController",
    "pid" : 14114
  },
  "timestamp" : "2022-02-21 23:33:55 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_EXIT",
  "process" : {
    "ancestors" : [
      1
    ],
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.UPMServiceController",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 0,
    "ppid" : 1,
    "path" : "/Library/Application Support/Zscaler/UPM/UPMServiceController",
    "architecture" : "unknown",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.UPMServiceController",
      "platformBinary" : 0,
      "cdHash" : "01B61E0427A76C25E77DBBDA823DB9BDEBF36623"
    },
    "exit code" : 15,
    "arguments" : [

    ],
    "pid" : 14114,
    "name" : "UPMServiceController",
    "rpid" : 14114
  },
  "timestamp" : "2022-02-21 23:33:56 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_EXEC",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.UPMServiceController",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 0,
    "arguments" : [
      "/Library/Application Support/Zscaler/UPM/UPMServiceController"
    ],
    "ppid" : 1,
    "ancestors" : [
      1
    ],
    "rpid" : 14161,
    "architecture" : "Intel",
    "path" : "/Library/Application Support/Zscaler/UPM/UPMServiceController",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.UPMServiceController",
      "platformBinary" : 0,
      "cdHash" : "01B61E0427A76C25E77DBBDA823DB9BDEBF36623"
    },
    "name" : "UPMServiceController",
    "pid" : 14161
  },
  "timestamp" : "2022-02-21 23:33:57 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_FORK",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.UPMServiceController",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 0,
    "arguments" : [

    ],
    "ppid" : 14161,
    "ancestors" : [
      14161,
      1
    ],
    "rpid" : 14161,
    "architecture" : "unknown",
    "path" : "/Library/Application Support/Zscaler/UPM/UPMServiceController",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.UPMServiceController",
      "platformBinary" : 0,
      "cdHash" : "01B61E0427A76C25E77DBBDA823DB9BDEBF36623"
    },
    "name" : "UPMServiceController",
    "pid" : 14167
  },
  "timestamp" : "2022-02-21 23:33:57 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_FORK",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.UPMServiceController",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 0,
    "arguments" : [

    ],
    "ppid" : 14161,
    "ancestors" : [
      14161,
      1
    ],
    "rpid" : 14161,
    "architecture" : "unknown",
    "path" : "/Library/Application Support/Zscaler/UPM/UPMServiceController",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.UPMServiceController",
      "platformBinary" : 0,
      "cdHash" : "01B61E0427A76C25E77DBBDA823DB9BDEBF36623"
    },
    "name" : "UPMServiceController",
    "pid" : 14169
  },
  "timestamp" : "2022-02-21 23:33:57 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_FORK",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.UPMServiceController",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 0,
    "arguments" : [

    ],
    "ppid" : 14161,
    "ancestors" : [
      14161,
      1
    ],
    "rpid" : 14161,
    "architecture" : "unknown",
    "path" : "/Library/Application Support/Zscaler/UPM/UPMServiceController",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.UPMServiceController",
      "platformBinary" : 0,
      "cdHash" : "01B61E0427A76C25E77DBBDA823DB9BDEBF36623"
    },
    "name" : "UPMServiceController",
    "pid" : 14172
  },
  "timestamp" : "2022-02-21 23:33:57 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_FORK",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.UPMServiceController",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 0,
    "arguments" : [

    ],
    "ppid" : 14161,
    "ancestors" : [
      14161,
      1
    ],
    "rpid" : 14161,
    "architecture" : "unknown",
    "path" : "/Library/Application Support/Zscaler/UPM/UPMServiceController",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.UPMServiceController",
      "platformBinary" : 0,
      "cdHash" : "01B61E0427A76C25E77DBBDA823DB9BDEBF36623"
    },
    "name" : "UPMServiceController",
    "pid" : 14173
  },
  "timestamp" : "2022-02-21 23:33:57 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_FORK",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.UPMServiceController",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 0,
    "arguments" : [

    ],
    "ppid" : 14161,
    "ancestors" : [
      14161,
      1
    ],
    "rpid" : 14161,
    "architecture" : "unknown",
    "path" : "/Library/Application Support/Zscaler/UPM/UPMServiceController",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.UPMServiceController",
      "platformBinary" : 0,
      "cdHash" : "01B61E0427A76C25E77DBBDA823DB9BDEBF36623"
    },
    "name" : "UPMServiceController",
    "pid" : 14176
  },
  "timestamp" : "2022-02-21 23:33:58 +0000"
}
```

*Zscaler*
```
➜  ~ sudo ~/Desktop/ProcessMonitor.app/Contents/MacOS/ProcessMonitor -pretty -filter Zscaler
Password:
{
  "event" : "ES_EVENT_TYPE_NOTIFY_EXEC",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.Zscaler",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 502,
    "arguments" : [
      "/Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler"
    ],
    "ppid" : 1,
    "ancestors" : [
      1
    ],
    "rpid" : 14118,
    "architecture" : "Intel",
    "path" : "/Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.Zscaler",
      "platformBinary" : 0,
      "cdHash" : "69C17FA4AA4AB5DEAD520423FD0EFA053B47CA43"
    },
    "name" : "Zscaler",
    "pid" : 14118
  },
  "timestamp" : "2022-02-21 23:33:55 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_FORK",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.Zscaler",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 502,
    "arguments" : [

    ],
    "ppid" : 14118,
    "ancestors" : [
      14118,
      1
    ],
    "rpid" : 14118,
    "architecture" : "unknown",
    "path" : "/Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.Zscaler",
      "platformBinary" : 0,
      "cdHash" : "69C17FA4AA4AB5DEAD520423FD0EFA053B47CA43"
    },
    "name" : "Zscaler",
    "pid" : 14145
  },
  "timestamp" : "2022-02-21 23:33:56 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_FORK",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.Zscaler",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 502,
    "arguments" : [

    ],
    "ppid" : 14118,
    "ancestors" : [
      14118,
      1
    ],
    "rpid" : 14118,
    "architecture" : "unknown",
    "path" : "/Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.Zscaler",
      "platformBinary" : 0,
      "cdHash" : "69C17FA4AA4AB5DEAD520423FD0EFA053B47CA43"
    },
    "name" : "Zscaler",
    "pid" : 14171
  },
  "timestamp" : "2022-02-21 23:33:57 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_FORK",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.Zscaler",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 502,
    "arguments" : [

    ],
    "ppid" : 14118,
    "ancestors" : [
      14118,
      1
    ],
    "rpid" : 14118,
    "architecture" : "unknown",
    "path" : "/Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.Zscaler",
      "platformBinary" : 0,
      "cdHash" : "69C17FA4AA4AB5DEAD520423FD0EFA053B47CA43"
    },
    "name" : "Zscaler",
    "pid" : 14175
  },
  "timestamp" : "2022-02-21 23:33:57 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_FORK",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.Zscaler",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 502,
    "arguments" : [

    ],
    "ppid" : 14118,
    "ancestors" : [
      14118,
      1
    ],
    "rpid" : 14118,
    "architecture" : "unknown",
    "path" : "/Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.Zscaler",
      "platformBinary" : 0,
      "cdHash" : "69C17FA4AA4AB5DEAD520423FD0EFA053B47CA43"
    },
    "name" : "Zscaler",
    "pid" : 14183
  },
  "timestamp" : "2022-02-21 23:33:58 +0000"
}
{
  "event" : "ES_EVENT_TYPE_NOTIFY_FORK",
  "process" : {
    "signing info (computed)" : {
      "teamID" : "PCBCQZJ7S7",
      "signatureID" : "com.zscaler.Zscaler",
      "signatureStatus" : 0,
      "signatureSigner" : "Developer ID",
      "signatureAuthorities" : [
        "Developer ID Application: Zscaler inc (PCBCQZJ7S7)",
        "Developer ID Certification Authority",
        "Apple Root CA"
      ]
    },
    "uid" : 502,
    "arguments" : [

    ],
    "ppid" : 14118,
    "ancestors" : [
      14118,
      1
    ],
    "rpid" : 14118,
    "architecture" : "unknown",
    "path" : "/Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler",
    "signing info (reported)" : {
      "teamID" : "PCBCQZJ7S7",
      "csFlags" : 570490881,
      "signingID" : "com.zscaler.Zscaler",
      "platformBinary" : 0,
      "cdHash" : "69C17FA4AA4AB5DEAD520423FD0EFA053B47CA43"
    },
    "name" : "Zscaler",
    "pid" : 14184
  },
  "timestamp" : "2022-02-21 23:33:58 +0000"
}
```

Looks like this keeps forking but there are no execs with each fork. Touch to get any idea whats going on here. I'll try again with Filemonitor.

This was slightly different. Looks like we got much more output

The UPMServiceController is writing sqlite database files here: /Library/Application Support/Zscaler/UPM/db

```
➜  db ls -la '/Library/Application Support/Zscaler/UPM/db'
total 5192
drwxr-xr-x  7 root  wheel      224 Feb 21 20:44 .
drwxr-xr-x  4 root  wheel      128 Feb 20 15:26 ..
-rw-r--r--  1 root  wheel   102400 Feb 21 20:44 upm_device_profile.db
-rw-r--r--  1 root  wheel   339968 Feb 21 20:44 upm_device_stats.db
-rw-r--r--  1 root  wheel  1036288 Feb 21 20:44 upm_traceroute.db
-rw-r--r--  1 root  wheel  1011712 Feb 21 20:44 upm_upload_stats.db
-rw-r--r--  1 root  wheel    36864 Feb 21 20:44 upm_webload.db
```

```
➜  db sudo sqlite3 upm_device_profile.db
SQLite version 3.32.2 2020-06-04 12:58:43
Enter ".help" for usage hints.
sqlite> .tables
tbl_cpu_info           tbl_interface_details  tbl_wifi_info
tbl_disk_info          tbl_system_info
```

Now I'm going to check the schema of all of these tables
```
sqlite> PRAGMA table_info(tbl_interface_details);
0|timestamp|INTEGER|0||0
1|refid|INTEGER|0||0
2|adapter_name|TEXT|0||0
3|ifname|TEXT|0||0
4|type|TEXT|0||0
5|status|TEXT|0||0
6|mac_addr|TEXT|0||0
7|ipv4|TEXT|0||0
8|ipv6|TEXT|0||0
9|link_speed_bps|TEXT|0||0
10|gateway|TEXT|0||0
11|gateway_mac_addr|TEXT|0||0
12|dns_svrs|TEXT|0||0
13|dns_suffix|TEXT|0||0
```

I'm specifically looking for fields that have values that might modify the behavior of the tool in a way that could compromise privacy. For example if one of these fields can be modified to reroute and intercept traffic, it might be worth looking at SQL injection, or debugging the SQL functions using lldb.

Its also useful to enumerate records sometimes to see what the tables look like
```
sqlite> SELECT * FROM tbl_interface_details LIMIT 5;
1645392369626|272259622285809|iBridge|en5||Connected|ac:de:48:00:11:22||fe80::aede:48ff:fe00:1122|100000000||||
1645392369626|272259622285809|Wi-Fi|en0|Wireless|Connected|14:7d:da:74:02:f3|192.168.1.3|fe80::140f:18a6:c3b5:b76d|54000000|192.168.1.1|3c:37:86:73:b6:75|192.168.1.1|
1645392369626|272259622285809|ThunderboltIP|en2|Ethernet|Media Disconnected|82:86:10:25:40:00|||10000000000||||
1645392369626|272259622285809|ThunderboltIP|en1|Ethernet|Media Disconnected|82:86:10:25:40:01|||10000000000||||
1645392369626|272259622285809|ThunderboltIP|en4|Ethernet|Media Disconnected|82:86:10:25:40:04|||10000000000||||
```

```
sqlite> select * From WebData;
37247|11|272259622285809|272259622285809|1|https://salesforce.zoom.us|1645392403314|1645392403|1645392403|668680|243517153|100|200|242379575|PG_LOAD_TM;TTFB_TM;DNS_TM|0|0||0|en0|0|0|0|0
9882|8645|272259622285809|272259622285809|0|https://salesforce.enterprise.slack.com|1645392477863|1645392477|1645392477|48284812|474061412|100|200|265988526|PG_LOAD_TM;TTFB_TM;DNS_TM|0|0||0|en0|0|0|0|0
37699|14157|272259622285809|272259622285809|0|https://meet.google.com/|1645392618109|1645392552|1645392618|0|0|0|0|0|PG_LOAD_TM;TTFB_TM;DNS_TM|4|0||0|en0|0|0|0|0
........
```

Nothing too interesting, but its good to have an idea of whats being stored in sqlite in case something comes up later.

The main takeaway from UPMServiceController is that it writes to a sqlite db
ZscalerTunnel looks to be writing to log files a lot.
One line of interested: 2022-02-22 02:39:07.637109(-0600)[24570:109085] INF request for credentials
ZScaler opened this file with a bunch of certs:
-rw-r--r--  1 jtulowiecki  staff  263668 Feb 21 20:39 /Users/jtulowiecki/Library/Application Support/com.zscaler.Zscaler/1804289383.pem
ZScaler has a lot of UI stuff
ZScalerService looks to be opening /Library/Application Support/Zscaler/UPM/UPMServiceController, which is odd I think since launchd is supposed to handle this
Hard to know what ZScalerService does, but it looks like it might serve as coordinator between tunnel and UPMServiceController

