---
layout: post
title: Pentesting OSX Software
---

Enumeration
Generally I would start with a pkg file to see whats being written to disk, but in this case all I had was a previously installed
version to test.

The first thing I noticed was there were several services associated with this application that are running as root
```
➜  ~ ps aux | grep -i zscaler
root             13377  21.9  0.1  6692360  38376   ??  Ss    9:18PM   0:31.18 /Library/Application Support/Zscaler/UPM/UPMServiceController
root             13387   0.0  0.0  6695692  17176   ??  Ss    9:18PM   0:01.74 /Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerTunnel
root             13355   0.0  0.0  5753088  18828   ??  Ss    9:18PM   0:00.40 /Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerService
jtulowiecki      13354   0.0  0.1  6959252  68460   ??  S     9:18PM   0:01.94 /Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler
```

To find out how these are being loaded, I looked to the startup files. The following two folders will run the service as root
➜  ~ find /Library/LaunchDaemons /System/Library/LaunchDaemons -type f | grep -i zscaler
/Library/LaunchDaemons/com.zscaler.service.plist
/Library/LaunchDaemons/com.zscaler.tunnel.plist
/Library/LaunchDaemons/com.zscaler.UPMServiceController.plist

And then these two directories will launch as user
➜  ~ find /Library/LaunchAgents /System/Library/LaunchAgents -type f | grep -i zscaler
/Library/LaunchAgents/com.zscaler.tray.plist

Now I went through each and looked to see if I could find anything interesting in these files:

```
cat /Library/LaunchDaemons/com.zscaler.service.plist
....
<dict>
	<key>Label</key>
	<string>com.zscaler.service</string>
	<key>MachServices</key>
	<dict>
		<key>com.zscaler.service-tray-communication</key>
		<true/>
	</dict>
	<key>EnvironmentVariables</key>
	<dict>
		<key>OPT</key>
		<string>ZSCALER</string>
	</dict>
	<key>ProgramArguments</key>
	<array>
		<string>/Applications/Zscaler/Zscaler.app/Contents/PlugIns/ZscalerService</string>
	</array>
	<key>KeepAlive</key>
	<dict>
		<key>SuccessfulExit</key>
		<false/>
	</dict>
	<key>RunAtLoad</key>
	<true/>
	<key>StandardErrorPath</key>
	<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerService.log</string>
	<key>StandardOutPath</key>
	<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerServiceOut.log</string>
</dict>
</plist>
```
KeepAlive is set, so the service should always be running. RunAtLoad is set, so this launches at startup, its
in the Daemons folder so it launches as root. An environment variable is set OPT=ZSCALER
Thats interesting, because it could be input into the application. The application is not passed any args

There are no ports being opened up or anythinglike that but there are two files referenced to show where
stdout and stderr write to:
<key>StandardErrorPath</key>
	<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerService.log</string>
	<key>StandardOutPath</key>
	<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerServiceOut.log</string>

This could prove useful later on as well. Also of interest is this:
<key>MachServices</key>
	<dict>
		<key>com.zscaler.service-tray-communication</key>
		<true/>
	</dict>

This tells launchd to create a Mach port and register it with the bootstrap service with the given string. Other services 
can then lookup the service by name, and send messages to it. So this is another potential attack vector depending on what
the application is doing with the message.

The results are fairly similar for this one:
```
cat /Library/LaunchDaemons/com.zscaler.tunnel.plist
```

The same environment variable is set, runatload, keepalive. The log files are different:
<key>StandardErrorPath</key>
	<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerTunnel.log</string>
	<key>StandardOutPath</key>
	<string>/Library/Application Support/Zscaler/com.zscaler.ZscalerTunnelOut.log</string>

A different Mach port is registered for this one:
<key>MachServices</key>
	<dict>
		<key>com.zscaler.tray-tunnel-communication</key>
		<true/>
	</dict>

The other file is again similar with the only differences being the mach port and the log files
➜  ~ cat /Library/LaunchDaemons/com.zscaler.UPMServiceController.plist
<key>MachServices</key>
	<dict>
		<key>com.zscaler.UPMServiceController</key>
		<true/>
	</dict>
<key>StandardErrorPath</key>
    <string>/Library/Application Support/Zscaler/Logs/com.zscaler.UPMServiceController_stderr.log</string>
    <key>StandardOutPath</key>
    <string>/Library/Application Support/Zscaler/Logs/com.zscaler.UPMServiceController_stdout.log</string>

The other one in LaunchAgents doesn't appear to be particularly interesting because it doesnt run as root,
has no log files or mach ports. I'll make a note that its there but there isn't much to go on there for now.

